version: '3.8'

services:
  # 后端服务
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: server
      args:
        # LightRAG 构建时初始化（从 .env 自动读取，使用 LLM_* 变量名）
        - INIT_LIGHTRAG_ON_BUILD=${INIT_LIGHTRAG_ON_BUILD:-true}
        - LLM_API_KEY=${LLM_API_KEY}
        - LLM_BASE_URL=${LLM_BASE_URL}
        - LLM_MODEL=${LLM_MODEL}
        - EMBEDDING_API_KEY=${EMBEDDING_API_KEY}
        - EMBEDDING_MODEL=${EMBEDDING_MODEL}
        - EMBEDDING_BASE_URL=${EMBEDDING_BASE_URL}
        - EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION}
        - LIGHTRAG_INIT_LIMIT=${LIGHTRAG_INIT_LIMIT}
    ports:
      - "8000:8000"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      # 基础配置
      - DEBUG=${DEBUG:-True}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_CACHE_EXPIRE=${REDIS_CACHE_EXPIRE:-43200}
      - REDIS_CACHE_THRESHOLD=${REDIS_CACHE_THRESHOLD:-0.92}
      - REDIS_CACHE_MAX_SIZE=${REDIS_CACHE_MAX_SIZE:-1000}

      # 数据库配置
      - DATABASE_URL=${DATABASE_URL}
      - MYSQL_ROOT_PASSWORD=rootpass
      - MYSQL_DATABASE=recipe_db
      - MYSQL_USER=recipe_user
      - MYSQL_PASSWORD=recipepass

      # Neo4j配置
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-recipepass}
      - NEO4J_DEFAULT_GRAPH_QUERY=${NEO4J_DEFAULT_GRAPH_QUERY}

      # Milvus配置
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      - MILVUS_COLLECTION=${MILVUS_COLLECTION:-recipes}
      - MILVUS_INDEX_TYPE=${MILVUS_INDEX_TYPE:-IVF_FLAT}
      - MILVUS_METRIC_TYPE=${MILVUS_METRIC_TYPE:-IP}

      # LLM配置
      - LLM_PROVIDER=${LLM_PROVIDER:-openai}
      - LLM_MODEL=${LLM_MODEL}
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_BASE_URL=${LLM_BASE_URL}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.7}

      # LightRAG配置（需要OPENAI_*变量）
      - OPENAI_API_KEY=${LLM_API_KEY}
      - OPENAI_API_BASE=${LLM_BASE_URL}
      - OPENAI_MODEL=${LLM_MODEL}
      - LIGHTRAG_WORKING_DIR=${LIGHTRAG_WORKING_DIR:-./data/lightrag}
      - LIGHTRAG_RETRIEVAL_MODE=${LIGHTRAG_RETRIEVAL_MODE:-hybrid}
      - LIGHTRAG_TOP_K=${LIGHTRAG_TOP_K:-10}
      - LIGHTRAG_MAX_TOKEN_SIZE=${LIGHTRAG_MAX_TOKEN_SIZE:-4096}
      - LIGHTRAG_ENABLE_NEO4J=${LIGHTRAG_ENABLE_NEO4J:-True}
      - LIGHTRAG_ENABLE_MILVUS=${LIGHTRAG_ENABLE_MILVUS:-False}
      - INIT_LIGHTRAG_ON_BUILD=${INIT_LIGHTRAG_ON_BUILD:-true}
      - LIGHTRAG_INIT_LIMIT=0
  
      # Embedding配置
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - EMBEDDING_API_KEY=${EMBEDDING_API_KEY}
      - EMBEDDING_BASE_URL=${EMBEDDING_BASE_URL}
      - EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION}

      # Rerank配置
      - RERANK_ENABLED=${RERANK_ENABLED}
      - RERANK_PROVIDER=${RERANK_PROVIDER}
      - RERANK_BASE_URL=${RERANK_BASE_URL}
      - RERANK_ENDPOINT=${RERANK_ENDPOINT}
      - RERANK_API_KEY=${RERANK_API_KEY}
      - RERANK_MODEL=${RERANK_MODEL}
      - RERANK_TIMEOUT=${RERANK_TIMEOUT:-30}
      - RERANK_MAX_CANDIDATES=${RERANK_MAX_CANDIDATES}
      - RERANK_TOP_N=${RERANK_TOP_N}
      - RERANK_SCORE_FUSION_ALPHA=${RERANK_SCORE_FUSION_ALPHA}

      # Vision模型配置
      - VISION_API_KEY=${VISION_API_KEY}
      - VISION_BASE_URL=${VISION_BASE_URL}
      - VISION_MODEL=${VISION_MODEL}

      # Image Generation配置
      - IMAGE_GENERATION_API_KEY=${IMAGE_GENERATION_API_KEY}
      - IMAGE_GENERATION_BASE_URL=${IMAGE_GENERATION_BASE_URL}
      - IMAGE_GENERATION_MODEL=${IMAGE_GENERATION_MODEL}
      - IMAGE_GENERATION_SIZE=${IMAGE_GENERATION_SIZE}

      # 知识库配置
      - KB_TOP_K=5
      - KB_SIMILARITY_THRESHOLD=${KB_SIMILARITY_THRESHOLD:-0.2}
      - KB_POSTGRES_SIMILARITY_THRESHOLD=${KB_POSTGRES_SIMILARITY_THRESHOLD:-0.5}
      - KB_POSTGRES_RERANK_THRESHOLD=${KB_POSTGRES_RERANK_THRESHOLD:-0.8}
      - KB_RERANK_SCORE_THRESHOLD=${KB_RERANK_SCORE_THRESHOLD:-0.8}
      - KB_CHUNK_SIZE=512
      - KB_CHUNK_OVERLAP=80
      - KB_ENABLE_EXTERNAL_SEARCH=false
      - INIT_KB_MILVUS=${INIT_KB_MILVUS:-true}
      - KB_DATA_FILE=${KB_DATA_FILE:-/app/data/kb/data.txt}
      - KB_MILVUS_SENTINEL=${KB_MILVUS_SENTINEL:-/app/data/.kb_milvus_ingested}

      # 会话配置
      - CONVERSATION_HISTORY_TTL=${CONVERSATION_HISTORY_TTL:-259200}
      - CONVERSATION_HISTORY_MAX_MESSAGES=${CONVERSATION_HISTORY_MAX_MESSAGES:-200}

      # 外部服务配置
      - INGEST_SERVICE_URL=${INGEST_SERVICE_URL:-http://kb_ingest:8000}
      - FILE_UPLOAD_MAX_MB=${FILE_UPLOAD_MAX_MB:-2}

      # Agent配置
      - MAX_ITERATIONS=${MAX_ITERATIONS:-10}
      - AGENT_TIMEOUT=${AGENT_TIMEOUT:-300}

      # CORS配置
      - CORS_ORIGINS=${CORS_ORIGINS}

      # Tiktoken缓存目录
      - TIKTOKEN_CACHE_DIR=/app/data/tiktoken_cache
    volumes:
      - ./gustobot:/app/gustobot
      - ./data:/app/data
      - ./uploads:/app/uploads
      - ./.env:/app/.env
    depends_on:
      - neo4j
      - redis
      - milvus
    networks:
      - gustobot-network
    restart: unless-stopped
    command: uvicorn gustobot.main:application --host 0.0.0.0 --port 8000 --reload

  neo4j:
    build:
      context: .
      dockerfile: Dockerfile
      target: neo4j_seeded
    ports:
      - "17474:7474"
      - "17687:7687"
    environment:
      NEO4J_AUTH: none
      NEO4J_dbms_security_auth__enabled: "false"
      NEO4J_dbms_security_procedures_unrestricted: "apoc.*"
      NEO4J_dbms_security_procedures_allowlist: "apoc.*"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - gustobot-network

  mysql:
    image: mysql:8.0
    ports:
      - "13306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=rootpass
      - MYSQL_DATABASE=recipe_db
      - MYSQL_USER=recipe_user
      - MYSQL_PASSWORD=recipepass
    volumes:
      - mysql_data:/var/lib/mysql
      - ./data/init_mysql.sql:/docker-entrypoint-initdb.d/00_init.sql
      - ./data/insert_sample_data.sql:/docker-entrypoint-initdb.d/10_seed.sql
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - gustobot-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - gustobot-network

  # Milvus向量数据库
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - etcd_data:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    networks:
      - gustobot-network

  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    ports:
      - "9001:9001"
      - "9000:9000"
    volumes:
      - minio_data:/minio_data
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - gustobot-network

  milvus:
    image: milvusdb/milvus:v2.3.3
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    depends_on:
      - etcd
      - minio
    networks:
      - gustobot-network

  kb_postgres:
    image: ankane/pgvector
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${KB_PGDATABASE:-vector_db}
      POSTGRES_USER: ${KB_PGUSER:-postgres}
      POSTGRES_PASSWORD: ${KB_PGPASSWORD:-postgres}
    ports:
      - "${KB_PG_PORT:-5433}:5432"
    volumes:
      - kb_pgdata:/var/lib/postgresql/data
      - ./docker/pgvector/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - gustobot-network

  kb_ingest:
    build:
      context: ./kb_ingest
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - kb_postgres
    dns:
      - 8.8.8.8
      - 8.8.4.4
    env_file:
      - .env
    environment:
      # PostgreSQL配置
      PGHOST: ${KB_PGHOST:-kb_postgres}
      PGPORT: ${KB_PGPORT:-5432}
      PGDATABASE: ${KB_PGDATABASE:-vector_db}
      PGUSER: ${KB_PGUSER:-postgres}
      PGPASSWORD: ${KB_PGPASSWORD:-postgres}
      # LLM配置
      LLM_PROVIDER: ${KB_LLM_PROVIDER:-openai}
      LLM_MODEL: ${KB_LLM_MODEL}
      LLM_API_KEY: ${KB_LLM_API_KEY}
      LLM_BASE_URL: ${KB_LLM_BASE_URL}
      LLM_TEMPERATURE: ${KB_LLM_TEMPERATURE:-0.3}
      USE_LLM: ${KB_USE_LLM:-false}
      # Embedding配置
      EMBEDDING_PROVIDER: ${KB_EMBEDDING_PROVIDER:-openai}
      EMBEDDING_MODEL: ${KB_EMBEDDING_MODEL}
      EMBEDDING_API_KEY: ${KB_EMBEDDING_API_KEY}
      EMBEDDING_BASE_URL: ${KB_EMBEDDING_BASE_URL}
      EMBEDDING_DIMENSION: ${KB_EMBEDDING_DIMENSION:-1024}
      # Rerank配置
      RERANK_ENABLED: ${KB_RERANK_ENABLED:-true}
      RERANK_PROVIDER: ${KB_RERANK_PROVIDER:-custom}
      RERANK_BASE_URL: ${KB_RERANK_BASE_URL}
      RERANK_ENDPOINT: ${KB_RERANK_ENDPOINT}
      RERANK_API_KEY: ${KB_RERANK_API_KEY}
      RERANK_MODEL: ${KB_RERANK_MODEL}
      RERANK_TIMEOUT: ${KB_RERANK_TIMEOUT:-30}
      RERANK_MAX_CANDIDATES: ${KB_RERANK_MAX_CANDIDATES:-20}
      RERANK_TOP_N: ${KB_RERANK_TOP_N:-6}
      RERANK_SCORE_FUSION_ALPHA: ${KB_RERANK_SCORE_FUSION_ALPHA:-0.5}
      # 批处理配置
      BATCH_SIZE: ${KB_BATCH_SIZE:-16}
      RETRY_TIMES: ${KB_RETRY_TIMES:-3}
      RETRY_DELAY: ${KB_RETRY_DELAY:-5}
      # Excel 初始数据导入
      INIT_KB_EXCEL: ${INIT_KB_EXCEL:-true}
      KB_EXCEL_PATH: ${KB_EXCEL_PATH:-/app/data/历史菜谱源头.xlsx}
      KB_EXCEL_SENTINEL: ${KB_EXCEL_SENTINEL:-/app/data/.kb_excel_ingested}
    ports:
      - "${KB_INGEST_PORT:-8100}:8000"
    volumes:
      - ./kb_ingest/data:/app/data
    command: uvicorn kb_service.main:app --host 0.0.0.0 --port 8000
    networks:
      - gustobot-network


networks:
  gustobot-network:
    driver: bridge

volumes:
  redis_data:
  etcd_data:
  minio_data:
  milvus_data:
  neo4j_data:
  neo4j_logs:
  mysql_data:
  kb_pgdata:
